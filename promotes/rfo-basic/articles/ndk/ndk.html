<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
  <META content="HTML Tidy for HTML5 for Linux version 5.6.0" name=
  "generator">
  <META http-equiv="content-type" content=
  "text/html; charset=utf-8">
  <META name="viewport" content=
  "width=device-width, initial-scale=1.0">
  <TITLE>ndk</TITLE>
  <LINK rel="stylesheet" href="main.css" type="text/css">
</HEAD>
<BODY vlink="#990099" link="#000099" alink="#000099">
  <BR style="font-family: Helvetica,Arial,sans-serif;">
  <A href="http://humpity.github.io/home.htm">Humpty Promotes</A>
  &gt; <A href=
  "http://humpity.github.io/promotes/rfo-basic/rfo.html">Rfo-Basic</A>
  &gt; <BIG style=
  "font-family: Helvetica,Arial,sans-serif;"><SMALL><A href=
  "../articles.html">Project Articles</A>
  &gt;</SMALL><SMALL><BR></SMALL></BIG><BR>
  <BR>
  <DIV style="text-align: left;">
    <BIG><BIG><SPAN style="color: rgb(0, 0, 153);">Android NDK
    binaries with rfo-Basic!</SPAN></BIG></BIG>&nbsp; <SMALL>(Sep
    2015 - <SPAN style=
    "font-style: italic;">outdated</SPAN>)</SMALL><BR>
  </DIV><BR>
  <TABLE style=
  "text-align: left; width: 100%; background-color: transparent;"
  cellspacing="2" cellpadding="2" border="0">
    <TBODY>
      <TR>
        <TD style="vertical-align: top;"><BR>
        ** This article is <SPAN style="font-weight: bold;">for
        reference only</SPAN><BR>
        &nbsp;&nbsp;&nbsp; Since Android 7.0 (Nougat), Google
        restricted the execution of native code<BR>
        &nbsp;&nbsp;&nbsp; to libraries only.<BR>
        &nbsp;&nbsp;&nbsp; This means that this method as verbatim
        <SPAN style="text-decoration: underline;">no longer
        works</SPAN>.&nbsp; -- once again thankyou Google.<BR>
        <BR>
        &nbsp;&nbsp;&nbsp; <SPAN style="font-style: italic;">A
        workaround is available - please private message the author
        in the forums.</SPAN><BR>
        ****<BR></TD>
        <TD class="large2" style=
        "vertical-align: top; width: 30%; white-space: nowrap;">
          <A href="ndk.html#hello">hello world</A><BR>
          <BR>
          <A href="ndk.html#What_is_NDK">What is NDK</A><BR>
          <DIV style="margin-left: 40px;">
            Why Use it?<BR>
            Simple Interface<BR>
          </DIV><A href="ndk.html#Make_a_Binary">Make a
          Binary</A><BR>
          <BR>
          <A href="ndk.html#Your_Basic_project">Your Basic!
          project</A><BR>
          <BR>
          <A href="ndk.html#About_the_Shell">About The
          Shell</A><BR>
          <DIV style="margin-left: 40px;">
            Process Properties<BR>
            Conditions for exit<BR>
            Communication<BR>
          </DIV><A href="#About_PIE">About&nbsp; PIE</A>
        </TD>
      </TR>
    </TBODY>
  </TABLE><SPAN style="text-decoration: underline;"><A name="hello"
  id="hello"></A></SPAN><BIG><BIG>T</BIG>he '<SPAN style=
  "color: rgb(0, 0, 153);">hello world</SPAN>' moment</BIG><BR>
  <BR style="font-family: Times New Roman,Times,serif;">
  <DIV class="large2" style="margin-left: 40px;">
    <SPAN style=
    "font-family: Times New Roman,Times,serif; text-decoration: underline;">
    'hello world'&nbsp;&nbsp;</SPAN><SPAN style=
    "font-family: Times New Roman,Times,serif; color: rgb(153, 51, 0);">&nbsp;&nbsp;
    <SPAN style="color: rgb(102, 0, 0);">/həˈləʊ/&nbsp;
    /wɜː(r)ld/&nbsp;&nbsp; [noun]&nbsp;&nbsp;
    [countable]</SPAN><BR style="color: rgb(102, 0, 0);">
    <BR style="color: rgb(102, 0, 0);"></SPAN> <SPAN style=
    "font-family: Times New Roman,Times,serif; color: rgb(102, 0, 0);">
    Desc:&nbsp; A wonderment that suspends you in time while future
    possibilites fly around your head like flies.</SPAN><BR style=
    "font-family: Times New Roman,Times,serif; color: rgb(102, 0, 0);">

    <SPAN style=
    "font-family: Times New Roman,Times,serif; color: rgb(102, 0, 0);">
    Occurrence:&nbsp; rare.</SPAN><BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <HR style="width: 100%; height: 2px;">
    <BR>
    <BIG>T</BIG>he only other time I remember was the very first
    output of my very first compiled language when a teenager.<BR>
    Subsequent events fade into boredom and indifference. And that
    wonderment gets forgotten, especially as languages and systems
    become monotonously similar as the years drag on.<BR>
    <BR>
    Surprisingly, the same feeling came back when executing a
    native c-binary from a basic! app on my Android
    phone.&nbsp;<BR>
    <SPAN style="color: rgb(0, 0, 153); font-style: italic;">'The
    phone is running 'c' made code !'&nbsp;</SPAN> For a few brief
    minutes, I was again a teenager.<BR>
    <BR>
    I don't know wether it was because of my usual bias against
    Java running android phones, or that I had forgotten that a
    phone was really just a small sized PC, or that I had mentally
    placed NDK as just another mass of geeky dependent-hell files
    designed not to work for 'normal' people. But that the binary
    actually ran, freaked me out and gave me quite a buzz for the
    rest of the day.<BR>
  </DIV><BR>
  <BIG><BIG>T</BIG></BIG>his guide is simply about how to make a
  native binary and run it from rfo-basic.<BR>
  <BR>
  <SPAN style=
  "text-decoration: underline;">Preliminaries</SPAN><BR>
  It is assummed you are familiar with;<BR>
  a) rfo-basic<BR>
  b) the c language and compilers<BR>
  c) OS terminals and scripts (windows or linux) and filenames.<BR>
  <BR>
  In this guide, we will be using the c language and our host PC is
  running linux. If you are using windows,<BR>
  just convert the filepaths/names and script commands
  accordingly.<BR>
  <BR>
  <HR style="width: 100%; height: 2px;">
  <BR>
  <BIG><SPAN style="text-decoration: underline;"><A name=
  "What_is_NDK" id="What_is_NDK"></A>What is
  NDK?</SPAN></BIG><BIG><BIG><BR></BIG></BIG><BR>
  <DIV style="margin-left: 40px;">
    The Android <SPAN style="color: rgb(0, 0, 153);">Native
    Development Kit</SPAN> is primarily a system of building cross
    compiled binaries of other languages to interface with
    Android's OS (which runs on Java). It relies heavily on using
    JNI as an interface to make library calls in-between the
    running binary and Java. But as you might have noticed, this
    website (about rfo-basic) avoids Java/XML due to it's
    complexities. So why use NDK at all?<BR>
    <BR>
    <SPAN class="large2" style="text-decoration: underline;">Why
    Use It ?</SPAN><BR>
    <BR>
    It so happens that you can still compile NDK binaries and have
    them <SPAN style="color: rgb(0, 0, 153);">execute</SPAN>
    <SPAN style="color: rgb(102, 0, 0);">without</SPAN> JNI as long
    as you don't call the Java libraries. Such needs are typically
    tasks which are cpu intensive and <SPAN style=
    "color: rgb(0, 0, 153);">don't need graphics or any other user
    interaction</SPAN>. e.g Background or service utilties e.g
    servers, batch file operations, or self contained utitlities
    which have already been proven and written in other
    languages.<BR>
    <BR>
    <SPAN class="large2" style="text-decoration: underline;">Simple
    Interface</SPAN><BR>
    <BR>
    All we need to do is to find a way to <SPAN style=
    "text-decoration: underline;">execute</SPAN> and perhaps devise
    a simple way for the binary to <SPAN style=
    "text-decoration: underline;">talk</SPAN> to the basic!
    program.<BR>
    <BR>
    Launching is not a problem, Basic! already has a built-in shell
    in the form of the <SPAN style=
    "color: rgb(0, 102, 0);">system.</SPAN> command, of which we
    can use to <SPAN style="color: rgb(0, 0, 153);">launch</SPAN>
    the binary.<BR>
    <BR>
    The next requirement is <SPAN style=
    "color: rgb(0, 0, 153);">somewhere to put the binary</SPAN>,
    where we can give it permissions to execute.<BR>
    All android apps are entitled a private area of storage called
    <SPAN style="color: rgb(0, 0, 153);">Primary Internal Private
    Storage</SPAN>. This is usually at location <SPAN style=
    "color: rgb(102, 0, 0);">/data/data/&lt;package_name&gt;</SPAN>.
    It is created when the app is installed. The app has full
    rights here, so putting the binary here means we can give it
    the <SPAN style="text-decoration: underline;">right to
    execute</SPAN>. Another bonus, is that the directory is wiped
    when the app is uninstalled.<BR>
    <BR>
    For communication between the binary and basic!, you can either
    use a protocol of read/write to temporary files, or
    alternatively the stdin/stdout of the shell/binary.<BR>
  </DIV><BR>
  <HR style="width: 100%; height: 2px;">
  <BIG style="text-decoration: underline;"><BR>
  <A name="Make_a_Binary" id="Make_a_Binary"></A>Make a
  Binary</BIG><BR>
  <BR>
  <DIV style="margin-left: 40px;">
    But first things first, let's see how we can build an actual
    binary with NDK.<BR>
    <BR>
    The development environment is more simple than you think.
    There is no special IDE, no drivers to install and you can
    install to anywhere you want. You don't even have to set any
    environment variables if you don't want. Configuration It is
    mostly setting values inside provided scripts.<BR>
    <BR>
    1. Download the latest <A href=
    "https://developer.android.com/ndk/downloads/index.html">NDK
    distribution</A>.<BR>
    <BR>
  </DIV>
  <DIV style="margin-left: 80px;">
    The NDK distro is a gigantic collection of compilers and
    toolchains (utilities for compilation) and examples that cater
    for windows, linux and mac.<BR>
    Pick the distro that matches your development PC.<BR>
    Download and run the self-extracter which will extract a tree
    of files to a directory of your choice.<BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    2. Check for build script <SPAN style=
    "color: rgb(0, 102, 0);">ndk-build</SPAN>.<BR>
    <BR>
  </DIV>
  <DIV style="margin-left: 80px;">
    In the main directory there is script file called '<SPAN style=
    "color: rgb(0, 102, 0);">ndk-build</SPAN>'<BR>
    <BR>
    This is the main script to call for compilation. Note it's
    location, you will need it for later.<BR>
    <BR>
    (For windows, you can use '<SPAN style=
    "color: rgb(0, 102, 0);">ndk-build.cmd</SPAN>' otherwise you
    need to install cygwin to be able to use the linux script)<BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    3. Navigate to the standalone example file.<BR>
    <BR>
  </DIV>
  <DIV style="margin-left: 80px;">
    Open a terminal and cd into <SPAN style=
    "color: rgb(102, 0, 0);">tests/standalone/basic-c-compile/jni/</SPAN><BR>
  </DIV>
  <DIV style="margin-left: 40px;"></DIV>
  <DIV style="text-align: right; margin-left: 80px;">
    <SMALL>(although we won't use jni, this is the standard
    sub-directory structure.)</SMALL><BR>
  </DIV>
  <DIV style="margin-left: 40px;"></DIV>
  <DIV style="margin-left: 80px;">
    <BR>
    This is where the source files and makefile go, and where we
    will be operating from.<BR>
    <BR>
    You will find a file called <SPAN style=
    "color: rgb(0, 0, 153);">main.c</SPAN> which is the 'hello
    world' c example.<BR>
    <DIV class="bordered">
      <SMALL><SPAN style="font-family: monospace;">#include
      &lt;stdio.h&gt;</SPAN></SMALL><BR style=
      "font-family: monospace;">
      <BR style="font-family: monospace;">
      <SMALL><SPAN style="font-family: monospace;">int
      main()</SPAN></SMALL><BR style="font-family: monospace;">
      <SMALL><SPAN style=
      "font-family: monospace;">{&nbsp;</SPAN></SMALL><BR style=
      "font-family: monospace;">
      <SMALL><SPAN style="font-family: monospace;">&nbsp;printf
      ("hello world\n");</SPAN></SMALL><BR style=
      "font-family: monospace;">
      <BR style="font-family: monospace;">
      <SMALL><SPAN style="font-family: monospace;">&nbsp;return
      0;</SPAN></SMALL><BR style="font-family: monospace;">
      <SMALL><SPAN style=
      "font-family: monospace;">}</SPAN></SMALL><BR style=
      "font-family: monospace;">
    </DIV><BR>
    Now we check if a makefile is here..<BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    4. Create <SPAN style=
    "color: rgb(0, 0, 153);">Android.mk</SPAN><BR>
    <BR>
  </DIV>
  <DIV style="margin-left: 80px;">
    Below is the makefile. If one is not provided, create this one
    (infact, you should probably use this one);<BR>
    <BR>
    Android.mk<BR>
  </DIV>
  <DIV style="margin-left: 40px;"></DIV>
  <DIV class="bordered" style="margin-left: 80px;">
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL>LOCAL_PATH:=
    $(call my-dir)<BR>
    include $(CLEAR_VARS)<BR>
    <BR>
    LOCAL_MODULE := <SPAN style=
    "color: rgb(0, 102, 0);">main</SPAN><BR>
    <BR>
    <SPAN style="color: rgb(102, 51, 0);">#APP_PLATFORM :=
    android-16</SPAN><BR style="color: rgb(102, 51, 0);">
    <SPAN style="color: rgb(102, 51, 0);">#LOCAL_CFLAGS +=
    -fPIE</SPAN><BR style="color: rgb(102, 51, 0);">
    <SPAN style="color: rgb(102, 51, 0);">#LOCAL_LDFLAGS += -fPIE
    -pie</SPAN><BR>
    <BR>
    LOCAL_SRC_FILES:= <SPAN style=
    "color: rgb(0, 0, 153);">main.c</SPAN><BR>
    <BR>
    include $(BUILD_EXECUTABLE)</SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
  </DIV>
  <DIV style="margin-left: 40px;"></DIV>
  <DIV style="margin-left: 80px;">
    <BR>
    This makefile takes one source file <SPAN style=
    "color: rgb(0, 0, 153);">main.c</SPAN>, it will compile and
    link it with android's <SPAN style=
    "color: rgb(0, 0, 153);">bionic</SPAN> library <SMALL>(a cut
    down version of the standard c library for android)</SMALL>,
    and generate a binary called <SPAN style=
    "color: rgb(0, 102, 0);">main</SPAN>.<BR>
    <BR>
    In the middle of the makefile are <SPAN style=
    "color: rgb(102, 51, 0);">3 commented lines.</SPAN> The 3 lines
    determine wether PIE is turned on or off. <SMALL><SPAN style=
    "font-family: monospace;"><BR>
    <BR></SPAN> <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL><SPAN style="color: rgb(102, 51, 0);">
    #APP_PLATFORM := android-16</SPAN><BR style=
    "color: rgb(102, 51, 0);">
    <SPAN style="color: rgb(102, 51, 0);">#LOCAL_CFLAGS +=
    -fPIE</SPAN><BR style="color: rgb(102, 51, 0);">
    <SPAN style="color: rgb(102, 51, 0);">#LOCAL_LDFLAGS += -fPIE
    -pie</SPAN></SMALL></SPAN></SMALL><BR>
    <BR>
    <SPAN style="color: rgb(102, 51, 0);">#commented</SPAN> =
    <SPAN style="color: rgb(0, 0, 153);">PIE disabled ( off
    )<BR></SPAN>un-commented = <SPAN style=
    "color: rgb(0, 0, 153);">PIE enabled ( on )<BR></SPAN><BR>
    If your Android phone version is <SPAN style=
    "color: rgb(0, 0, 153);">JellyBean or later (4.1+) i.e api16+,
    then</SPAN> un-comment <SPAN style="color: rgb(0, 0, 153);">the
    lines</SPAN> (PIE on).<BR>
    If your Android phone version is older, i.e is less than
    4.1,&nbsp; then <SPAN style="color: rgb(102, 51, 0);">#comment
    the lines</SPAN> out (PIE Off)<BR>
    <BR>
    (see later for explanation of PIE)<BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    5. Create a compile script.<BR>
    <BR>
  </DIV>
  <DIV style="margin-left: 80px;">
    In this directory, create a script called <SPAN style=
    "color: rgb(0, 102, 0);">go.sh</SPAN> (or go.cmd) and type in
    the path to the main build script ndk-build. e.g<BR>
    <BR>
    <SPAN style="color: rgb(0, 102, 0);">go.sh</SPAN><BR>
    <DIV style="margin-left: 40px;">
      <SPAN style=
      "color: rgb(102, 51, 0);">/mnt/sda4/dev/android-ndk-r10d/</SPAN><SPAN style="color: rgb(0, 102, 0);">ndk-build</SPAN><BR>
    </DIV><SPAN style="color: rgb(102, 51, 0);"><BR></SPAN>This
    means you can run this script instead of setting up environment
    variables with a path.<BR>
    You will run '<SPAN style=
    "color: rgb(0, 102, 0);">go.sh</SPAN>' whenever you need to
    compile in this directory.<BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    6. Compile<BR>
    <BR>
  </DIV>
  <DIV style="margin-left: 80px;">
    Run the compile script <SPAN style=
    "color: rgb(0, 102, 0);">./go.sh</SPAN><BR>
    This should generate any executables inside <SPAN style=
    "color: rgb(102, 0, 0);">../libs/armeabi/</SPAN><BR>
    i.e <SPAN style=
    "color: rgb(102, 0, 0);">../libs/armeabi/</SPAN><SPAN style=
    "color: rgb(0, 102, 0);">main</SPAN><BR>
    <SMALL>(It will also generate some files in
    ../obj/local/armeabi/ but we aren't interested in
    those.)</SMALL><BR>
    <BR>
    <SPAN style="color: rgb(0, 102, 0);">main</SPAN> is the binary
    executable which you will copy to your phone (see later).<BR>
  </DIV><BR>
  <HR style="width: 100%; height: 2px;">
  <BR>
  <BIG><SPAN style="text-decoration: underline;"><A name=
  "Your_Basic_project" id="Your_Basic_project"></A>Your Basic!
  project</SPAN></BIG><BR>
  <BR>
  <DIV style="margin-left: 40px;">
    For editor mode, the <SPAN style=
    "color: rgb(102, 0, 0);">package_name</SPAN> is "<SPAN style=
    "color: rgb(102, 51, 0);">com.rfo.basic</SPAN>".<BR>
    For Apk, the package name is whatever you named your
    package(<SMALL>with your apk builder</SMALL>),<BR>
    For both cases, the project directory will be <SPAN style=
    "color: rgb(102, 0, 0);">/mnt/sdcard/&lt;package_name&gt;/</SPAN><BR>

    <BR>
    1. Copy the <SPAN style=
    "text-decoration: underline; color: rgb(0, 102, 0);">binary</SPAN>
    you compiled to your <SPAN style=
    "color: rgb(102, 0, 0);">&lt;&gt;/data</SPAN> directory. e.g
    <SPAN style=
    "color: rgb(102, 0, 0);">/mnt/sdcard/rfo-basic/data/</SPAN><SPAN style="color: rgb(0, 102, 0);">main</SPAN><BR>

    <BR>
    2. In your program, initialise the basic shell and go to
    private storage <SPAN style=
    "color: rgb(102, 0, 0);">/data/data/&lt;package_name&gt;</SPAN><BR>

    <BR>
  </DIV>
  <DIV class="bordered" style="margin-left: 80px;">
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">p$="<SPAN style=
    "color: rgb(102, 51, 0);">com.rfo.basic</SPAN>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <SPAN style="color: rgb(102, 102, 102);">% package
    name</SPAN></SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">path$ = "<SPAN style=
    "color: rgb(102, 0, 0);">/data/data/</SPAN>"+p$+"/"</SMALL></SPAN><SPAN style="font-family: Courier New, Courier, monospace;"><BR>
    </SPAN> <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">system.open</SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">system.write "cd "+ path$+"
    2&gt;&amp;1"</SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">pause 50</SMALL></SPAN><BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    3. Copy over the binary to <A href="../storage.html">private
    storage</A><BR>
    <BR>
  </DIV>
  <DIV class="bordered" style=
  "margin-left: 80px; color: rgb(102, 51, 0);">
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL><SPAN style="color: rgb(0, 0, 153);">
    <SPAN style="color: rgb(0, 102, 0);">b$</SPAN>="<SPAN style=
    "color: rgb(0, 102, 0);">main</SPAN>"&nbsp;&nbsp; &nbsp;&nbsp;
    &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;
    <SPAN style="color: rgb(102, 102, 102);">% binary
    name</SPAN><BR>
    file.root datapath$&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
    <SPAN style="color: rgb(102, 102, 102);">%
    &lt;base&gt;/data</SPAN></SPAN><BR style=
    "color: rgb(0, 0, 153);">
    <SPAN style="color: rgb(0, 0, 153);">srce$ =
    datapath$+"/"+b$</SPAN><BR style="color: rgb(0, 0, 153);">
    <SPAN style="color: rgb(0, 0, 153);">system.write ("cat
    "+srce$+" &gt;./"+b$+" 2&gt;&amp;1")</SPAN></SMALL></SPAN><BR>
  </DIV>
  <DIV style="margin-left: 40px;"></DIV>
  <DIV style="margin-left: 160px;">
    <SMALL>note: the binary should first be in &lt;base&gt;/data.
    If making a package either the apk-builder should ensure this
    or your basic program should pre-copy this from assets to
    &lt;base&gt; /data.</SMALL><BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    4. Make the binary executable<BR>
    <BR>
  </DIV>
  <DIV class="bordered" style="margin-left: 80px;">
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">system.write "chmod 777 "+<SPAN style=
    "color: rgb(0, 102, 0);">b$</SPAN>+" 2&gt;&amp;1"&nbsp;
    <SPAN style="color: rgb(102, 102, 102);">% make
    executable</SPAN></SMALL></SPAN><BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    5. Run It.<BR>
    <BR>
  </DIV>
  <DIV class="bordered" style="margin-left: 80px;">
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL><SPAN style="color: rgb(0, 0, 153);">
    system.write "<SPAN style=
    "color: rgb(0, 102, 0);">./"+b$</SPAN>+"
    2&gt;&amp;1"&nbsp;&nbsp; <SPAN style=
    "color: rgb(102, 102, 102);">% execute
    binary</SPAN></SPAN></SMALL></SPAN><BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    6. Get the Output<BR>
    <BR>
  </DIV>
  <DIV class="bordered" style="margin-left: 80px;">
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">r$=""&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
    &nbsp;&nbsp;&nbsp; <SPAN style="color: rgb(102, 102, 102);">%
    assume no reponse</SPAN></SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">pause 1000</SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">system.READ.READY
    ready&nbsp;&nbsp;&nbsp; <SPAN style=
    "color: rgb(102, 102, 102);">% if
    response</SPAN></SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">while ready</SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">&nbsp;&nbsp; &nbsp;&nbsp;
    system.READ.LINE l$</SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">&nbsp;&nbsp; &nbsp;&nbsp; r$ +=
    l$+"\n"</SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">&nbsp;&nbsp; &nbsp;&nbsp;
    system.READ.READY ready</SMALL></SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">repeat<BR>
    print r$&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;
    &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <SPAN style=
    "color: rgb(102, 102, 102);">%
    output</SPAN></SMALL></SPAN><SMALL style=
    "font-family: monospace; color: rgb(0, 0, 153);"><BR></SMALL>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    7. Cleanup and close the shell<BR>
    <BR>
  </DIV>
  <DIV class="bordered" style="margin-left: 80px;">
    <SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">onBackKey:<BR></SMALL></SPAN>
    <DIV style="margin-left: 40px;">
      <SPAN style=
      "font-family: Courier New, Courier, monospace;"><SMALL style=
      "color: rgb(0, 0, 153);">system.close<BR>
      system.open<BR>
      system.write "cd "+ path$ + ";rm "+b$&nbsp;&nbsp;
      <SPAN style="color: rgb(102, 102, 102);">% delete the
      binary<BR></SPAN></SMALL></SPAN><SPAN style=
      "font-family: Courier New, Courier, monospace;"><SMALL style=
      "color: rgb(0, 0, 153);">pause 100</SMALL></SPAN><SPAN style=
      "font-family: Courier New, Courier, monospace;"><BR></SPAN>
      <SPAN style=
      "font-family: Courier New, Courier, monospace;"><SMALL style=
      "color: rgb(0, 0, 153);">system.close<BR></SMALL></SPAN>
    </DIV><SPAN style=
    "font-family: Courier New, Courier, monospace;"><SMALL style=
    "color: rgb(0, 0, 153);">end</SMALL></SPAN><SMALL style=
    "font-family: monospace; color: rgb(0, 0, 153);"><BR></SMALL>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    When you run this basic program, it should copy over and
    execute the binary in a shell, then spool any output to the
    screen. Any shell errors will normally show by the spooling. If
    all goes well, you will see "hello world" .<BR>
  </DIV><BR>
  That's It !<BR>
  <HR style="width: 100%; height: 2px;">
  <BR>
  <BIG style="text-decoration: underline;"><A name=
  "About_the_Shell" id="About_the_Shell"></A>About the
  Shell</BIG><BR>
  <BR>
  <DIV style="margin-left: 40px;">
    Basic! can execute binaries because of it's <SPAN style=
    "color: rgb(0, 102, 0);">system</SPAN> command. This is a shell
    by which you can pass commands to. You can only open one shell
    at a time but even so, it is a powerful tool.<BR>
    <BR>
    <SPAN style="text-decoration: underline;">Process
    Properties</SPAN><BR>
  </DIV>
  <DIV style="margin-left: 80px;">
    The shell is a truly spawned parallel process.<BR>
    The executed binary is also a truly spawned parallel
    process.<BR>
    Basic, the shell and the binary will all have differing
    PIDs.<BR>
    <BR>
    Both the shell and the binary might be seen under 'Basic' in a
    task manager but the shell process is named "<SPAN style=
    "color: rgb(102, 0, 0);">sh</SPAN>" and the binary process is
    named with it's called command e.g "<SPAN style=
    "color: rgb(102, 0, 0);">./main</SPAN>"<BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    <SPAN style="text-decoration: underline;">Conditions for
    exit</SPAN><BR>
  </DIV>
  <DIV style="margin-left: 80px;">
    If Basic exits or ends, it will also close the shell (if still
    open).<BR>
    If the shell is closed, any spawned binaries will continue to
    run.<BR>
    If Basic crashes, then both the shell and the binaries may
    continue executing.<BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
    <SPAN style=
    "text-decoration: underline;">Communication</SPAN><BR>
    Because the binary is forked from the shell, they will share
    the same environment. This means stdin/stdout will be
    shared.<BR>
    <BR>
    <SPAN style="text-decoration: underline;">Data from
    binary/shell to Basic.</SPAN><BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <DIV style="margin-left: 80px;">
      Any data sent to stdout will set <SPAN style=
      "color: rgb(0, 102, 0);">system.read.ready</SPAN>
      <SPAN style="color: rgb(102, 51, 0);">true</SPAN> after a
      linefeed (line based).<BR>
      If Basic does not read the data, any furthur data will be
      buffered.<BR>
      The binary may need to flush it's output stream to ensure
      this.<BR>
      <BR>
      If the shell or binary has nothing to send, (or any sent data
      is not yet flushed),<BR>
      and any previous data has already been read then <SPAN style=
      "color: rgb(0, 102, 0);">system.read.ready</SPAN> will be
      <SPAN style="color: rgb(102, 51, 0);">false</SPAN>,<BR>
      <BR>
      Regardless of any condition of <SPAN style=
      "color: rgb(0, 102, 0);">system.read.ready</SPAN>, Basic will
      always continue to the next instruction (will not be
      blocked).<BR>
    </DIV>
    <DIV style="margin-left: 40px;">
      <BR>
    </DIV><SPAN style="text-decoration: underline;">Data from Basic
    to</SPAN> <SPAN style=
    "text-decoration: underline;">binary/shell</SPAN><SPAN style=
    "text-decoration: underline;">.</SPAN><BR>
    Any <SPAN style="color: rgb(0, 102, 0);">system.write</SPAN>
    will be sent to stdin.<BR>
    If the shell or binary is not reading stdin, the data will be
    buffered and Basic will continue to the next instruction (will
    not be blocked).<BR>
    <BR>
    If the binary is reading from stdin and there is no data sent
    (from Basic), then the binary will be blocked.<BR>
  </DIV><BR>
  <HR style="width: 100%; height: 2px;">
  <BR>
  <BIG style="text-decoration: underline;"><A name="About_PIE" id=
  "About_the_PIE"></A>About&nbsp; PIE<BR>
  <BR></BIG>
  <DIV style="margin-left: 40px;">
    In Jun 2012, Google began to enable PIE (Position Independent
    Executables) in Android as a security measure.<BR>
    They sneaked this into the OS starting with JellyBean (4.1) and
    ending with KitKat (4.4). This was the 'grace period' whereby
    any phone within this range is able to execute both PIE and
    non-PIE compiled code. Any phone after this range (starting
    with Lollipop (5.0)) will only execute PIE binaries.<BR>
    <BR>
    This means older phones (&lt; v4.1) don't work with PIE while
    newer phones (&gt;4.4) don't work without it.<BR>
    <BR>
    The only choice left for binary makers then, was either to
    force the customer to upgrade their phones or make sure the
    package ships with both types of binaries. For the latter case,
    the app will need to choose which binary to execute at
    runtime.<BR>
    <BR>
    Fortunately in Basic, you can get the OS version like this<BR>
    <BR>
  </DIV>
  <DIV style="margin-left: 80px;">
    <SPAN style=
    "font-family: Courier New, Courier, monospace;">a=0</SPAN><SPAN style="font-family: Courier New, Courier, monospace;"><BR>
    </SPAN> <SPAN style=
    "font-family: Courier New, Courier, monospace;">device
    a</SPAN><SPAN style=
    "font-family: Courier New, Courier, monospace;"><BR></SPAN>
    <SPAN style=
    "font-family: Courier New, Courier, monospace;">bundle.get a,
    "OS", s$</SPAN><SMALL><BR>
    <BR style="font-family: monospace;"></SMALL>
  </DIV>
  <DIV style="margin-left: 40px;">
    With a bit of manipulation, you can convert this to an integer
    value to decide which binary to use.<BR>
    (For apk making, you will need permission <SPAN style=
    "font-style: italic;">READ_PHONE_STATE</SPAN> for the 'device'
    command)<BR>
    <BR>
    &nbsp; Copy over the binary to private storage matching the OS
    pie or no-pie version. (modify the program above like
    this;)<BR>
  </DIV>
  <DIV style="margin-left: 40px;">
    <BR>
  </DIV>
  <TABLE style="text-align: left; width: 50%; margin-left: 40px;"
  cellspacing="2" cellpadding="2" border="0">
    <TBODY>
      <TR>
        <TD style="vertical-align: top;"><SPAN style=
        "font-family: Courier New, Courier, monospace;"><SMALL><SPAN style="color: rgb(0, 0, 153);">
        <SPAN style=
        "color: rgb(0, 102, 0);">b$</SPAN>="<SPAN style="color: rgb(0, 102, 0);">main</SPAN>"&nbsp;&nbsp;
        &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;
        &nbsp;&nbsp; <SPAN style="color: rgb(102, 102, 102);">%
        binary name</SPAN><BR>
        file.root datapath$&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
        <SPAN style="color: rgb(102, 102, 102);">%
        &lt;base&gt;/data<BR>
        <BR></SPAN></SPAN> a=0<BR>
        device a<BR>
        bundle.get a, "OS", s$<BR>
        v= val(word$(s$,1,"\\."))*10+val(word$(s$,2,"\\."))<BR>
        if v&lt;41 then suffix$="-nopie" else
        suffix$="-pie"<BR></SMALL></SPAN> <SPAN style=
        "font-family: Courier New, Courier, monospace;"><SMALL><SPAN style="color: rgb(0, 0, 153);">
        <SPAN style="color: rgb(102, 102, 102);"><BR></SPAN></SPAN>
        <SPAN style="color: rgb(0, 0, 153);">srce$ =
        datapath$+"/"+b$+<SPAN style=
        "color: black;">suffix$</SPAN></SPAN><BR style=
        "color: rgb(0, 0, 153);">
        <SPAN style="color: rgb(0, 0, 153);">system.write ("cat
        "+srce$+" &gt;./"+b$+"
        2&gt;&amp;1")</SPAN></SMALL></SPAN></TD>
      </TR>
    </TBODY>
  </TABLE>
  <DIV style="margin-left: 40px;">
    <BR>
    &nbsp;&nbsp;&nbsp; Note that the final binary copied to private
    storage need not have the pie/nopie suffix.<BR>
    <BR>
    Ofcourse this means you have to compile two versions of your
    binary, <SPAN style="color: rgb(0, 102, 0);">main-pie</SPAN>
    and <SPAN style="color: rgb(0, 102, 0);">main-nopie</SPAN>.<BR>
    Android.mk can build both versions at the same time.<BR>
    <BR>
    Android.mk<BR>
    <BR>
  </DIV>
  <TABLE style="text-align: left; width: 90%; margin-left: 40px;"
  cellspacing="2" cellpadding="2" border="0">
    <TBODY>
      <TR>
        <TD style="vertical-align: top;"><TT><SMALL>LOCAL_PATH:=
        $(call my-dir)<BR>
        include $(CLEAR_VARS)<BR>
        <BR>
        LOCAL_MODULE := <SPAN style=
        "color: rgb(0, 102, 0);">main-nopie</SPAN><BR>
        <BR>
        LOCAL_SRC_FILES:= main.c<BR>
        <BR>
        include $(BUILD_EXECUTABLE)<BR>
        <BR>
        #------------------------------<BR>
        include $(CLEAR_VARS)<BR>
        <BR>
        LOCAL_MODULE := <SPAN style=
        "color: rgb(0, 102, 0);">main-pie</SPAN><BR>
        <BR>
        LOCAL_SRC_FILES:= main.c<BR>
        <BR>
        APP_PLATFORM := android-16<BR>
        LOCAL_CFLAGS += -fPIE<BR>
        LOCAL_LDFLAGS += -fPIE -pie<BR>
        <BR>
        include $(BUILD_EXECUTABLE)</SMALL></TT></TD>
        <TD style="vertical-align: top;"><SMALL><SPAN style=
        "font-family: monospace;">Output<BR>
        <BR>
        $ go.sh</SPAN><BR style="font-family: monospace;">
        <SPAN style="font-family: monospace;"><SPAN style=
        "font-family: monospace;">[armeabi] Compile thumb&nbsp; :
        main-nopie &lt;= main.c</SPAN><BR style=
        "font-family: monospace;">
        <SPAN style="font-family: monospace;">[armeabi]
        Executable&nbsp;&nbsp;&nbsp;&nbsp; :
        main-nopie</SPAN><BR style="font-family: monospace;">
        <SPAN style="font-family: monospace;">[armeabi]
        Install&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :
        main-nopie =&gt; libs/armeabi/main-nopie</SPAN><BR style=
        "font-family: monospace;">
        <SPAN style="font-family: monospace;">[armeabi] Compile
        thumb&nbsp; : main-pie &lt;= main.c</SPAN><BR style=
        "font-family: monospace;">
        <SPAN style="font-family: monospace;">[armeabi]
        Executable&nbsp;&nbsp;&nbsp;&nbsp; :
        main-pie</SPAN><BR style="font-family: monospace;">
        <SPAN style="font-family: monospace;">[armeabi]
        Install&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :
        main-pie =&gt; libs/armeabi/main-pie</SPAN><SPAN style=
        "font-family: Arial,Helvetica,sans-serif;"><BR></SPAN></SPAN></SMALL></TD>
      </TR>
    </TBODY>
  </TABLE>
  <DIV style="margin-left: 40px;">
    <BR>
    <BR>
    <SMALL style="font-style: italic;">note: since NDK
    10d:</SMALL><BR>
    <SMALL style="font-style: italic;">PIE is supposed to be
    anabled by default if APP_PLATFORM := android-16</SMALL><BR>
    <SMALL style="font-style: italic;">but experience suggests this
    is not enough. To be sure that PIE is enabled, also set
    :</SMALL><BR>
    <SMALL style="font-style: italic;">LOCAL_CFLAGS +=
    -fPIE</SMALL><BR>
    <SMALL style="font-style: italic;">LOCAL_LDFLAGS += -fPIE
    -pie</SMALL><BR>
  </DIV><BR>
  <HR style="width: 100%; height: 2px;">
  -End.<BR>
  <HR style="width: 100%; height: 2px;">
  <BR>
  Sources and Acknowledgements:<BR>
  <BR>
  <SMALL>https://en.wikipedia.org/wiki/Android_version_history</SMALL><BR>

  <SMALL>https://www.duosecurity.com/blog/exploit-mitigations-in-android-jelly-bean-4-1</SMALL><BR>

  <SMALL>http://stackoverflow.com/questions/24818902/running-a-native-library-on-android-l-error-only-position-independent-executab</SMALL><BR>

  <BR>
  <HR style=
  "width: 100%; height: 2px; font-family: Helvetica,Arial,sans-serif;">

  <BR style="font-family: Helvetica,Arial,sans-serif;">
  <SCRIPT type="text/javascript" src=
  "http://humpity.github.io/main_index.js"></SCRIPT>
</BODY>
</HTML>
